<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/event-controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/event-controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

/**
 * Event pages
 *
 * @module controllers/event-controller
 */

const forms = require('../core/forms')
const templating = require('../controllers/templating')
const eventService = require('../services/event-service')
const eventThemeService = require('../services/event-theme-service')
const postService = require('../services/post-service')
const securityService = require('../services/security-service')

module.exports = {
  eventMiddleware,

  viewEventAnnouncements,
  viewEventPosts,
  viewEventThemes,
  viewEventGames,
  viewEventResults,

  editEvent,
  editEventThemes,
  deleteEvent,

  ajaxFindThemes,
  ajaxSaveVote
}

/**
 * Fetches the event &amp; optionally the user's entry
 */
async function eventMiddleware (req, res, next) {
  if (req.params.eventName !== 'create-event') {
    let event = await eventService.findEventByName(req.params.eventName)
    res.locals.event = event
    if (!event) {
      res.errorPage(404, 'Event not found')
      return
    } else {
      if (!res.locals.pageTitle) {
        res.locals.pageTitle = event.get('title')
        res.locals.pageDescription = 'An Alakajam! event. Dates: ' + event.get('display_dates') + '.'
        if (event.get('display_theme')) {
          res.locals.pageDescription += ' Theme: ' + event.get('display_theme')
        }
      }

      let announcementTask = postService.findLatestAnnouncement({ eventId: event.id })
          .then((announcement) => { res.locals.latestEventAnnouncement = announcement })

      let entryTask = true
      let userPostTask = true
      if (res.locals.user) {
        entryTask = eventService.findUserEntryForEvent(res.locals.user, event.get('id'))
            .then(userEntry => { res.locals.userEntry = userEntry })
        userPostTask = postService.findPost({
          userId: res.locals.user.id,
          eventId: res.locals.event.id,
          specialPostType: null
        }).then(userPost => { res.locals.userPost = userPost })
      }
      await Promise.all([announcementTask, entryTask, userPostTask])
    }
  }
  next()
}

/**
 * Browse event announcements
 */
async function viewEventAnnouncements (req, res) {
  res.locals.pageTitle += ' | Announcements'

  res.render('event/view-event-announcements', {
    posts: await postService.findPosts({
      eventId: res.locals.event.get('id'),
      specialPostType: 'announcement'
    })
  })
}

/**
 * Browse event posts
 */
async function viewEventPosts (req, res) {
  res.locals.pageTitle += ' | Posts'

  res.render('event/view-event-posts', {
    posts: await postService.findPosts({
      eventId: res.locals.event.get('id'),
      specialPostType: null
    }),
    pageCount: await postService.findPosts({
      eventId: res.locals.event.get('id'),
      specialPostType: null,
      pageCount: true
    })
  })
}

/**
 * Browse event theme voting
 */
async function viewEventThemes (req, res) {
  res.locals.pageTitle += ' | Themes'

  let statusThemes = res.locals.event.get('status_theme')
  if (statusThemes === 'disabled' || statusThemes === 'off') {
    res.errorPage(404)
  } else {
    let context = {}

    if (forms.isId(statusThemes)) {
      context.themesPost = await postService.findPostById(statusThemes)
    } else {
      if (req.method === 'POST') {
        let {fields} = await req.parseForm()

        if (fields.action === 'ideas') {
          // Gather ideas data
          let ideas = []
          for (let i = 0; i &lt; 3; i++) {
            let idField = fields['idea-id[' + i + ']']
            if (forms.isId(idField) || !idField) {
              ideas.push({
                id: idField,
                title: forms.sanitizeString(fields['idea-title[' + i + ']'])
              })
            }
          }
          // Update theme ideas
          await eventThemeService.saveThemeIdeas(res.locals.user, res.locals.event, ideas)
        } else if (fields.action === 'vote') {
          if (forms.isId(fields['theme-id']) &amp;&amp; (fields['upvote'] !== undefined || fields['downvote'] !== undefined)) {
            let score = (fields['upvote'] !== undefined) ? 1 : -1
            await eventThemeService.saveVote(res.locals.user, res.locals.event, parseInt(fields['theme-id']), score)
          }
        }
      }

      // Gather info for display
      if (res.locals.user) {
        let userThemesCollection = await eventThemeService.findThemeIdeasByUser(res.locals.user, res.locals.event)
        context.userThemes = userThemesCollection.models

        let votesHistoryCollection = await eventThemeService.findThemeVotesHistory(res.locals.user, res.locals.event)
        context.votesHistory = votesHistoryCollection.models
      } else {
        let sampleThemesCollection = await eventThemeService.findThemesToVoteOn(null, res.locals.event)
        context.sampleThemes = sampleThemesCollection.models
      }
    }

    res.render('event/view-event-themes', context)
  }
}

/**
 * Browse event games
 */
async function viewEventGames (req, res) {
  res.locals.pageTitle += ' | Games'

  if (res.locals.event.get('status_entry') !== 'on') {
    res.errorPage(404)
    return
  }

  let sortedEntries = res.locals.event.related('entries')
    .sortBy(function (entry) {
      return -1 * entry.get('feedback_score')
    })

  res.render('event/view-event-games', {
    sortedEntries
  })
}

/**
 * Browse event results
 */
async function viewEventResults (req, res) {
  res.locals.pageTitle += ' | Results'

  let statusResults = res.locals.event.get('status_results')
  if (forms.isId(statusResults)) {
    res.locals.resultsPost = await postService.findPostById(statusResults)
  } else if (statusResults !== 'on') {
    res.errorPage(404)
    return
  }

  res.render('event/view-event-results')
}

/**
 * Edit or create an event
 */
async function editEvent (req, res) {
  if (!securityService.isAdmin(res.locals.user)) {
    res.errorPage(403)
    return
  }

  let { fields } = await req.parseForm()
  let errorMessage = null
  let infoMessage = null
  let redirected = false

  if (fields &amp;&amp; fields.name &amp;&amp; fields.title) {
    let event = res.locals.event
    let creation = !event

    // TODO Typed fields should not be reset if validation fails
    if (!forms.isSlug(fields.name)) {
      errorMessage = 'Name is not a valid slug'
    } else if (fields.name.indexOf('-') === -1) {
      errorMessage = 'Name must contain at least one hyphen (-)'
    } else if (!forms.isIn(fields.status, ['pending', 'open', 'closed'])) {
      errorMessage = 'Invalid status'
    } else if (!forms.isIn(fields['status-rules'], ['disabled', 'off']) &amp;&amp;
        !forms.isId(fields['status-rules'])) {
      errorMessage = 'Invalid welcome/rules post status'
    } else if (!forms.isIn(fields['status-theme'], ['disabled', 'off', 'on']) &amp;&amp;
        !forms.isId(fields['status-theme'])) {
      errorMessage = 'Invalid theme status'
    } else if (!forms.isIn(fields['status-entry'], ['disabled', 'off', 'on'])) {
      errorMessage = 'Invalid entry status'
    } else if (!forms.isIn(fields['status-results'], ['disabled', 'off', 'on']) &amp;&amp;
        !forms.isId(fields['status-results'])) {
      errorMessage = 'Invalid results status'
    } else if (event) {
      let matchingEventsCollection = await eventService.findEvents({ name: fields.name })
      for (let matchingEvent of matchingEventsCollection.models) {
        if (event.id !== matchingEvent.id) {
          errorMessage = 'Another event with the same exists'
        }
      }
    }

    if (!errorMessage) {
      if (creation) {
        event = eventService.createEvent()
      }

      event.set({
        title: forms.sanitizeString(fields.title),
        name: fields.name,
        display_dates: forms.sanitizeString(fields['display-dates']),
        display_theme: forms.sanitizeString(fields['display-theme']),
        status: fields.status,
        status_rules: fields['status-rules'],
        status_theme: fields['status-theme'],
        status_entry: fields['status-entry'],
        status_results: fields['status-results'],
        countdown_config: {
          date: forms.parseDateTime(fields['countdown-date']),
          phrase: forms.sanitizeString(fields['countdown-phrase']),
          enabled: fields['countdown-enabled'] === 'on'
        }
      })

      let nameChanged = event.hasChanged('name')
      event = await event.save()
      if (nameChanged) {
        await eventService.refreshEventReferences(event)
      }

      if (creation) {
        res.redirect(templating.buildUrl(event, 'event', 'edit'))
        redirected = true
      }
    }
  }

  if (!redirected) {
    res.render('event/edit-event', {
      infoMessage,
      errorMessage
    })
  }
}

/**
 * Manage the event's submitted themes
 */
async function editEventThemes (req, res) {
  let themesCollection = await eventThemeService.findBestThemes(res.locals.event, { fetchAll: true })
  res.render('event/edit-event-themes', {
    themes: themesCollection.models
  })
}

/**
 * Delete an event
 */
async function deleteEvent (req, res) {
  if (!securityService.isAdmin(res.locals.user)) {
    res.errorPage(403)
    return
  }

  await res.locals.event.destroy()
  res.redirect('/events')
}

/**
 * AJAX API: Find themes to vote on
 */
async function ajaxFindThemes (req, res) {
  let themesCollection = await eventThemeService.findThemesToVoteOn(res.locals.user, res.locals.event)
  let json = []
  for (let theme of themesCollection.models) {
    json.push({
      id: theme.get('id'),
      title: theme.get('title')
    })
  }
  res.end(JSON.stringify(json))
}

/**
 * AJAX API: Save a vote
 */
async function ajaxSaveVote (req, res) {
  let {fields} = await req.parseForm()
  if (forms.isId(fields['id']) &amp;&amp; (fields['upvote'] !== undefined || fields['downvote'] !== undefined)) {
    let score = (fields['upvote'] !== undefined) ? 1 : -1
    await eventThemeService.saveVote(res.locals.user, res.locals.event, parseInt(fields['id']), score)
  }
  res.end('')
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controllers.html">controllers</a></li><li><a href="module-controllers_api-controller.html">controllers/api-controller</a></li><li><a href="module-controllers_entry-controller.html">controllers/entry-controller</a></li><li><a href="module-controllers_event-controller.html">controllers/event-controller</a></li><li><a href="module-controllers_main-controller.html">controllers/main-controller</a></li><li><a href="module-controllers_post-controller.html">controllers/post-controller</a></li><li><a href="module-controllers_templating.html">controllers/templating</a></li><li><a href="module-controllers_user-controller.html">controllers/user-controller</a></li><li><a href="module-core_cache.html">core/cache</a></li><li><a href="module-core_constants.html">core/constants</a></li><li><a href="module-core_db.html">core/db</a></li><li><a href="module-core_file-storage.html">core/file-storage</a></li><li><a href="module-core_forms.html">core/forms</a></li><li><a href="module-core_log.html">core/log</a></li><li><a href="module-core_middleware.html">core/middleware</a></li><li><a href="module-core_models.html">core/models</a></li><li><a href="module-server.html">server</a></li><li><a href="module-services_event-service.html">services/event-service</a></li><li><a href="module-services_event-theme-service.html">services/event-theme-service</a></li><li><a href="module-services_invite-service.html">services/invite-service</a></li><li><a href="module-services_post-service.html">services/post-service</a></li><li><a href="module-services_security-service.html">services/security-service</a></li><li><a href="module-services_session-service.html">services/session-service</a></li><li><a href="module-services_setting-service.html">services/setting-service</a></li><li><a href="module-services_user-service.html">services/user-service</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Aug 18 2017 11:59:09 GMT+0200 (Paris, Madrid (heure d’été))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
