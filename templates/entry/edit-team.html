{% extends "_page.html" %}
{% import "user/_macros-user.html" as userMacros %}

{% block styles %}
<link rel="stylesheet" href="/static/css/select2.min.css" />
<link rel="stylesheet" href="/static/css/select2-bootstrap.min.css" />
{% endblock %}

{% block body %}
<style>
form .select2.select2-container {
  width: 200px;
}
.select2-selection__choice.owner .select2-selection__choice__remove {
  display: none;
}
.select2-search-choice-close {
  left: 6px !important;
  top: 14px;
}
.select2-search-choice {
  padding-bottom: 2px !important;
}

.member {
  font-size: 16px;
  padding-left: 4px;
  padding-right: 4px;
}
.member>.avatar {
  width: 36px;
  border: 4px solid #3bafda;
  border-radius: 6px;
  vertical-align: middle;
  text-align: center;
  margin-right: 8px;
  margin-left: 2px;
}
.member>.username {
  margin-right: 2px;
}

#result-msg.error {
  color: red;
}
</style>

<div class="container">
  <div class="row">
    <div class="col-sm-12">
      <form id="edit-team" action>
        <div id="result-box" class="form-group" style="display:none;">
          <h3 id="result-msg"></h3>
          <ul id="conflict-list" style="display:none;"></ul>
          <div id="removed-msg" style="display:none;"></div>
          <div id="added-msg" style="display:none;"></div>
        </div>

        <div class="form-group">
          <h3>Members</h3>
          <input type="hidden" name="members" class="bigdrop" id="search-members" style="width:300px" multiple="multiple" />
        </div>

        <div class="form-group">
          <button id="save-team" disabled="disabled" type="submit" class="btn btn-submit dirtiable">Save changes</button>

          <button id="revert-changes" disabled="disabled" type="button" class="btn dirtiable">Revert changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="/static/js/select2.min.js"></script>
<script type="text/javascript">
$(function() {(function(members, url) {
  var eSaveBtn = $('#save-team').click(attemptSave),
      eRemovedMsg = $('#removed-msg'),
      eAddedMsg = $('#added-msg'),
      eConflictList = $('#conflict-list'),
      eResultMsg = $('#result-msg'),
      eResultBox = $('#result-box'),
      eForm = $('#edit-team'),
      eDirtiable = $('.dirtiable')
      eSelect = $('#search-members'),
      eRevert = $('#revert-changes')
      savingCls = 'saving'

  function toId (obj) {
    return obj.id
  }

  function plural (sing, pl, count) {
    return count === 1 ? sing : pl
  }

  function result (opt) {
    if (!opt) {
      return eResultBox.hide()
    }
    eResultBox.show().toggleClass('error', !!opt.error)
    eResultMsg.text(opt.message)
    eConflictList.html($.map(opt.conflicts || [], function(c) {
      return '<li class="conflict">' + c.user_title + '</li>'
    })).toggle(opt.conflicts.length > 0)
    eRemovedMsg.toggle(!!opt.removed).text('(' + opt.removed + ' ' + plural('user', 'users', opt.removed) + ' removed)')
    eAddedMsg.toggle(!!opt.added).text('(' + opt.added + ' ' + plural('user', 'users', opt.added) + ' added)')
  }

  function onRevert () {
    eDirtiable.prop('disabled', true)
    eSelect.select2('val', $.map(members, toId))
  }

  function onSaveSuccess (data) {
    eDirtiable.prop('disabled', true)
    eSaveBtn.removeClass(savingCls).text('Save changes')
    var hasConflicts = data.conflicts.length > 0
    members = data.members
    result({
      message: hasConflicts ? 'Some users have already entered:' : 'Team saved successfully!',
      conflicts: data.conflicts,
      removed: data.numRemoved,
      added: data.numAdded,
      error: hasConflicts
    })
  }

  function onSaveFailure (e) {
    result({
      message: 'Save failed! Please try again later or alert an admin.',
      error: true
    })
    eSaveBtn.text('Save changes').removeClass(savingCls)
  }

  function attemptSave (ev) {
    ev.preventDefault()
    eSaveBtn.text('Saving...').addClass(savingCls)
    var data = eForm.serializeArray().reduce(function(obj, field) {
      obj[field.name] = field.value
      return obj
    }, {})
    $.post("{{ buildUrl(entry, 'entry', 'save-team') }}", data).then(onSaveSuccess, onSaveFailure)
  }

  function format (user) {
    const avatarUrl = user.avatar || '/static/images/default-avatar.png'
    return ['<div class="member"><img class="avatar" src="', avatarUrl, '" alt="', user.text, '" /><span class="username">', user.text, '</span></div>'].join('')
  }

  function isDirty () {
    return arraysEqual(members.map(toId).sort(), eSelect.select2('val').sort())
  }

  function arraysEqual (a, b) {
    var len = a.length, i
    if (len !== b.length) {
      return false
    }
    a.sort()
    b.sort()
    for (i = 0; i < len; ++i) {
      if (a[i] !== b[i]) {
        return false
      }
    }
    return true
  }

  eRevert.click(onRevert)
  eSelect.select2({
    multiple: true,
    ajax: {
      url: url,
      dataType: 'json',
      delay: 300,
      data: function(term) {
        return {
          name: term,
        }
      },
      processResults: function (data, params) {
        $.each(data.matches, function(i, m) {
          m.disabled = (m.status === 'unavailable')
        })
        return {
          results: data.matches
        }
      },
      cache: true
    },
    initSelection: function(elem, cb) {
      cb(members)
    },
    sortResults: function(results) {
      return results.sort(function(a, b) {
        if (a.text < b.text) return -1;
        if (a.text > b.text) return 1;
        return 0;
      });
    },
    placeholder: 'Select team members',
    width: 300,
    allowClear: false,
    minimumInputLength: 3,
    formatResult: format,
    formatSelection: format
  })
  .select2('val', members)
  .on('change', function(ev) {
    eDirtiable.prop('disabled', isDirty())
  })
})(
  {{ members | dump | safe }},
  "{{ buildUrl(entry, 'entry', 'find-team-mate') }}"
) })
</script>
{% endblock %}
